---
- name: Install development packages necessary for building Python
  sudo: yes
  apt:
    pkg: "{{ item }}"
    state: present
  with_items:
    - git
    - libssl-dev
    - libbz2-dev
    - libsqlite3-dev
    - libreadline-dev

- name: Install PyEnv
  sudo_user: "{{deploy_user}}"
  git:
    repo: https://github.com/yyuu/pyenv.git
    dest: "{{ pyenv_path }}"

- name: Install PyEnv-virtualenv plugin
  sudo_user: "{{deploy_user}}"
  git:
    repo: https://github.com/yyuu/pyenv-virtualenv.git
    dest: "{{ pyenv_path }}/plugins/pyenv-virtualenv"

- name: Install .pyenvrc
  sudo_user: "{{deploy_user}}"
  template:
    src: ".pyenvrc.j2"
    dest: "{{ pyenv_path }}/.pyenvrc"
    owner: "{{ pyenv_owner }}"
    group: "{{ pyenv_owner }}"
    mode: "0644"

- name: Modify .bashrc
  sudo_user: "{{deploy_user}}"
  lineinfile: dest="/home/{{ pyenv_owner }}/.bashrc"
              regexp="\.pyenvrc$"
              line="source {{ pyenv_path }}/.pyenvrc"
              state=present

- name: Install Python interpreters 3.4.1
  sudo_user: "{{deploy_user}}"
  shell: . {{ pyenv_path }}/.pyenvrc && pyenv install 3.4.1
         creates="{{ pyenv_path }}/versions/3.4.1/bin/python"

- name: Create virtual environments
  sudo_user: "{{deploy_user}}"
  shell: . {{ pyenv_path }}/.pyenvrc && pyenv virtualenv 3.4.1 {{app_name}}-3.4.1
         creates="{{ pyenv_path }}/versions/{{app_name}}-3.4.1/bin/python"
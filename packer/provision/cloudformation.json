{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation for a VPC with RDS and web instances",

  "Parameters" : {

    "ClientID": {
      "Description" : "Client ID (IAA Number)",
      "Default": "PC-20140812-20190811-01",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "Environment": {
      "Description" : "Name of the environment (staging or production)",
      "Default": "staging",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "ReleaseTag": {
      "Description" : "Tag name you want to deploy of the application",
      "Default": "0.9",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "DomainName": {
      "Description" : "The domain name this is deploying to",
      "Default": "donate.peacecorps-dev.18f.us",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "PayGovDomainName": {
      "Description" : "The pay.gov endpoint domain name",
      "Default": "pay.donate.peacecorps-dev.18f.us",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "HostedZoneName": {
      "Description" : "The name of the hosted zone in Route 53 to use. Note the trailing period.",
      "Default": "18f.us.",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "KeyName": {
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
      "Default": "18f-aws-herron",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "DBName": {
      "Default": "peacecorpsprod",
      "Description" : "Postgres database name",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters."
    },

    "DBUsername": {
      "NoEcho": "true",
      "Default": "peacecorps",
      "Description" : "Username for Postgres database access",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription" : "must begin with a letter and contain only alphanumeric characters."
    },

    "DBPassword": {
      "NoEcho": "true",
      "Default": "secret111",
      "Description" : "Password for Postgres database access",
      "Type": "String",
      "MinLength": "8",
      "MaxLength": "41",
      "AllowedPattern" : "[a-zA-Z0-9]*",
      "ConstraintDescription" : "must contain only alphanumeric characters."
    },

    "DBAllocatedStorage": {
      "Default": "10",
      "Description" : "The size of the database (Gb)",
      "Type": "Number",
      "MinValue": "5",
      "MaxValue": "1024",
      "ConstraintDescription" : "must be between 5 and 1024Gb."
    },

    "SecretKey": {
      "NoEcho": "true",
      "Description" : "Secret Key to use for Django",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "GPGEncryptID": {
      "Description" : "GPG Encrypt ID",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern" : "[\\x20-\\x7E]*",
      "ConstraintDescription" : "can contain only ASCII characters."
    },

    "DeployToken": {
      "NoEcho": "true",
      "Description" : "Github Oauth Deploy Token",
      "Default": "",
      "Type": "String"
    },

    "WebAMI": {
      "Description" : "AMI to use for web instances",
      "Default": "ami-7c521914",
      "MinLength": "1",
      "MaxLength": "255",
      "Type": "String"
    },

    "PayGovAMI": {
      "Description" : "AMI to use for pay.gov instances",
      "Default": "ami-ca5219a2",
      "MinLength": "1",
      "MaxLength": "255",
      "Type": "String"
    },

    "NATAMI": {
      "Description" : "AMI to use for NAT instances",
      "Default": "ami-8a6f24e2",
      "MinLength": "1",
      "MaxLength": "255",
      "Type": "String"
    }

  },

  "Resources" : {

    "mainVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock" : "10.19.61.0/24",
        "EnableDnsSupport" : "true",
        "EnableDnsHostnames" : "true",
        "InstanceTenancy" : "default",
        "Tags" : [
          {"Key" : "Name", "Value" : { "Ref": "AWS::StackName" } },
          {"Key" : "Application", "Value" : { "Ref": "AWS::StackName" } },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "WebSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable HTTP and HTTPS access",
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - WebSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "80",
            "ToPort" : "80",
            "CidrIp" : "0.0.0.0/0"
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "443",
            "ToPort" : "443",
            "CidrIp" : "0.0.0.0/0"
          }
        ],
        "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "LocalTrafficSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable access to local ips",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - LocalTrafficSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "0",
             "ToPort" : "65535",
             "CidrIp" : "10.19.61.0/24"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "PublicSSHSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable SSH access via port 22 to known CIDR",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - PublicSSHSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "22",
             "ToPort" : "22",
             "CidrIp" : "159.142.0.0/16"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "AllSSHSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable SSH access via port 22 to everyone",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - AllSSHSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "22",
             "ToPort" : "22",
             "CidrIp" : "0.0.0.0/0"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "TrustedWebSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable Web Access to Trusted parties",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - TrustedWebSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "159.142.0.0/16"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "65.205.231.0/24"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "72.37.171.131/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "72.37.171.132/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "80.254.156.99/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "80.254.156.100/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "159.142.0.0/16"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "65.205.231.0/24"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "72.37.171.131/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "72.37.171.132/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "80.254.156.99/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "80.254.156.100/32"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "PayGovSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable access to pay.gov",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - PayGovSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "199.169.197.157/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "199.169.192.157/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "80",
             "ToPort" : "80",
             "CidrIp" : "199.169.194.157/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "199.169.197.157/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "199.169.192.157/32"
         },
         {
             "IpProtocol" : "tcp",
             "FromPort" : "443",
             "ToPort" : "443",
             "CidrIp" : "199.169.194.157/32"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "RDSSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" :
      {
       "GroupDescription" : "Enable postgres access to local ips",
       "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps - RDSSecurityGroup" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ],
       "SecurityGroupIngress" : [
         {
             "IpProtocol" : "tcp",
             "FromPort" : "5432",
             "ToPort" : "5432",
             "CidrIp" : "10.19.61.0/24"
         }
       ],
       "VpcId" : { "Ref" : "mainVPC" }
      }
    },

    "PublicSubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1a",
        "VpcId" : { "Ref" : "mainVPC" },
        "CidrBlock" : "10.19.61.0/27",
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps PublicSubnetA" },
          {"Key" : "Network", "Value" : "Public" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "PublicSubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1b",
        "VpcId" : { "Ref" : "mainVPC" },
        "CidrBlock" : "10.19.61.32/27",
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps PublicSubnetB" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Public" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "PrivateSubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1a",
        "VpcId" : { "Ref" : "mainVPC" },
        "CidrBlock" : "10.19.61.64/27",
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps PrivateSubnetA" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Private" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "PrivateSubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1b",
        "VpcId" : { "Ref" : "mainVPC" },
        "CidrBlock" : "10.19.61.96/27",
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps PrivateSubnetA" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Private" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps Internet Gateway" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Public" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "AttachGateway" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "mainVPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "mainVPC"},
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps Public Route Table" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Public" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "PublicRoute" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "PublicSubnetRouteTableAssociationA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnetA" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "PublicSubnetRouteTableAssociationB" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnetB" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "PrivateRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "mainVPC"},
        "Tags" : [
          {"Key" : "Name", "Value" : "Peace Corps Private Route Table" },
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Network", "Value" : "Private" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "PrivateRoute" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "InstanceId" : { "Ref" : "NAT" }
      }
    },

    "PrivateSubnetRouteTableAssociationA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnetA" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable" }
      }
    },

    "PrivateSubnetRouteTableAssociationB" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnetB" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable" }
      }
    },

    "AccessS3SecretsRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "ec2.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/"
      }
    },

    "AccessS3SecretsPolicy": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "s3-peacecorps-secrets-get",
        "PolicyDocument": {
          "Version" : "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": { "Fn::Join" : [ "", [
              "arn:aws:s3:::peacecorps-secrets/",
              { "Ref": "Environment" },
              "/*"
            ]]}
          }]
        },
        "Roles": [ { "Ref": "AccessS3SecretsRole" } ]
      }
    },

    "AccessS3SecretsProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          { "Ref": "AccessS3SecretsRole" }
        ]
      }
    },

    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "VPC Subnets",
        "SubnetIds": [
          { "Ref": "PrivateSubnetA" },
          { "Ref": "PrivateSubnetB" }
        ],
        "Tags" : [
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Name", "Value" : "Peace Corps DB Subnet Group" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "RDS": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine" : "Postgres",
        "DBName" : { "Ref": "DBName" },
        "MultiAZ" : "true",
        "MasterUsername": { "Ref": "DBUsername" },
        "MasterUserPassword": { "Ref" : "DBPassword" },
        "DBInstanceClass": "db.m1.small",
        "AllocatedStorage": { "Ref" : "DBAllocatedStorage" },
        "DBSubnetGroupName": { "Ref" : "DBSubnetGroup" },
        "VPCSecurityGroups": [
          { "Ref" : "RDSSecurityGroup" }
        ],
        "Tags" : [
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
          {"Key" : "Name", "Value" : "Peace Corps Database" },
          {"Key" : "Client", "Value" : { "Ref": "ClientID" } }
        ]
      }
    },

    "NAT" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn" : "AttachGateway",
      "Properties" : {
        "InstanceType" : "t2.micro",
        "KeyName" : { "Ref" : "KeyName" },
        "SourceDestCheck" : "false",
        "ImageId" : { "Ref": "NATAMI" },
        "IamInstanceProfile": {
          "Ref": "AccessS3SecretsProfile"
        },
        "NetworkInterfaces" : [
          {
            "AssociatePublicIpAddress" : true,
            "DeleteOnTermination" : true,
            "DeviceIndex": 0,
            "SubnetId": {
              "Ref": "PublicSubnetA"
            },
            "GroupSet": [
              { "Ref" : "WebSecurityGroup" },
              { "Ref" : "LocalTrafficSecurityGroup" },
              { "Ref" : "PublicSSHSecurityGroup" },
              { "Ref" : "AllSSHSecurityGroup" }
            ]
          }
        ],
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName"}},
          { "Key" : "Name", "Value" : { "Fn::Join" : ["-", ["cf", { "Ref": "AWS::StackName" }, "nat"]]}},
          { "Key" : "Client", "Value" : { "Ref": "ClientID" }}
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          ""
        ]]}}
      }
    },

    "WebASGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "AvailabilityZones" : [
          { "Fn::GetAtt" : [ "PrivateSubnetA", "AvailabilityZone" ] },
          { "Fn::GetAtt" : [ "PrivateSubnetB", "AvailabilityZone" ] }
        ],
        "HealthCheckGracePeriod" : 3000,
        "HealthCheckType" : "ELB",
        "LaunchConfigurationName" : { "Ref" : "WebLaunchConfig" },
        "LoadBalancerNames" : [ { "Ref" : "WebELB" } ],
        "MaxSize" : "5",
        "MinSize" : "2",
        "DesiredCapacity" : "2",
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName"}, "PropagateAtLaunch": true },
          { "Key" : "Name", "Value" : { "Fn::Join" : ["-", ["cf", { "Ref": "AWS::StackName" }, "web", "asg"]]}, "PropagateAtLaunch": true },
          { "Key" : "Client", "Value" : { "Ref": "ClientID" }, "PropagateAtLaunch": true }
        ],
        "VPCZoneIdentifier" : [ { "Ref" : "PrivateSubnetA" } , { "Ref" : "PrivateSubnetB" } ]
      },
      "UpdatePolicy" : {
        "AutoScalingScheduledAction" : {
          "IgnoreUnmodifiedGroupSizeProperties" : "true"
        },
        "AutoScalingRollingUpdate" : {
          "MinInstancesInService" : "1",
          "MaxBatchSize" : "2",
          "PauseTime" : "PT2M"
        }
      }
    },

    "WebLaunchConfig" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "DependsOn" : "NAT",
      "Properties" : {
        "AssociatePublicIpAddress" : false,
        "ImageId" : { "Ref" : "WebAMI" },
        "InstanceType" : "m3.medium",
        "KeyName" : { "Ref" : "KeyName" },
        "SecurityGroups" : [
          { "Ref" : "LocalTrafficSecurityGroup" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -ex\n",
          "sed -i 's/{{SECRET_KEY}}/", { "Ref" : "SecretKey" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_NAME}}/", { "Ref" : "DBName" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_USER}}/", { "Ref" : "DBUsername" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_PASS}}/", { "Ref" : "DBPassword" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_HOST}}/", { "Fn::GetAtt" : [ "RDS", "Endpoint.Address" ]}, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{GPG_ENCRYPT_ID}}/", { "Ref" : "GPGEncryptID" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{MEMCACHED_URL}}/", "", "/g' /home/peacecorps/webserver-init.sh\n",
          "chown peacecorps:peacecorps /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{ReleaseTag}}/", { "Ref" : "ReleaseTag" }, "/g' /home/peacecorps/deploy_install_release.sh\n",
          "source /home/peacecorps/deploy_install_release.sh",
          "chown peacecorps:peacecorps /home/peacecorps/deploy_install_release.sh\n",
          "service nginx restart\n",
          "service peacecorps restart\n",
          "restart peacecorps\n",
          ""
        ]]}}
      }
    },

    "WebELB" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "SecurityGroups" : [ { "Ref" : "WebSecurityGroup" } ],
        "Policies": [
          {
            "PolicyName": "EnableProxyProtocolPolicy",
            "PolicyType": "ProxyProtocolPolicyType",
            "Attributes": [
              {
                "Name": "ProxyProtocol",
                "Value": true
              }
            ],
            "InstancePorts": ["443"]
          }
        ],
        "Subnets" : [
          { "Ref" : "PublicSubnetA" },
          { "Ref" : "PublicSubnetB" }
        ],
        "Listeners" : [ {
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP"
        },
        {
          "LoadBalancerPort" : "443",
          "InstancePort" : "443",
          "Protocol" : "TCP"
        }
        ],
        "HealthCheck": {
           "HealthyThreshold" : "2",
           "Interval" : "5",
           "Target" : "TCP:443",
           "Timeout" : "4",
           "UnhealthyThreshold" : "3"
        }
      }
    },


    "PayGovASGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "AvailabilityZones" : [
          { "Fn::GetAtt" : [ "PrivateSubnetA", "AvailabilityZone" ] },
          { "Fn::GetAtt" : [ "PrivateSubnetB", "AvailabilityZone" ] }
        ],
        "HealthCheckGracePeriod" : 3000,
        "HealthCheckType" : "ELB",
        "LaunchConfigurationName" : { "Ref" : "PayGovLaunchConfig" },
        "LoadBalancerNames" : [ { "Ref" : "PayGovELB" } ],
        "MaxSize" : "5",
        "MinSize" : "2",
        "DesiredCapacity" : "2",
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName"}, "PropagateAtLaunch": true },
          { "Key" : "Name", "Value" : { "Fn::Join" : ["-", ["cf", { "Ref": "AWS::StackName" }, "paygov", "asg"]]}, "PropagateAtLaunch": true },
          { "Key" : "Client", "Value" : { "Ref": "ClientID" }, "PropagateAtLaunch": true }
        ],
        "VPCZoneIdentifier" : [ { "Ref" : "PrivateSubnetA" } , { "Ref" : "PrivateSubnetB" } ]
      },
      "UpdatePolicy" : {
        "AutoScalingScheduledAction" : {
          "IgnoreUnmodifiedGroupSizeProperties" : "true"
        },
        "AutoScalingRollingUpdate" : {
          "MinInstancesInService" : "1",
          "MaxBatchSize" : "2",
          "PauseTime" : "PT2M"
        }
      }
    },

    "PayGovLaunchConfig" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "DependsOn" : "NAT",
      "Properties" : {
        "AssociatePublicIpAddress" : false,
        "ImageId" : { "Ref" : "PayGovAMI" },
        "InstanceType" : "t2.micro",
        "KeyName" : { "Ref" : "KeyName" },
        "SecurityGroups" : [
          { "Ref" : "LocalTrafficSecurityGroup" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -ex\n",
          "sed -i 's/{{SECRET_KEY}}/", { "Ref" : "SecretKey" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_NAME}}/", { "Ref" : "DBName" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_USER}}/", { "Ref" : "DBUsername" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_PASS}}/", { "Ref" : "DBPassword" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{PG_HOST}}/", { "Fn::GetAtt" : [ "RDS", "Endpoint.Address" ]}, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{GPG_ENCRYPT_ID}}/", { "Ref" : "GPGEncryptID" }, "/g' /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{MEMCACHED_URL}}/", "", "/g' /home/peacecorps/webserver-init.sh\n",
          "chown peacecorps:peacecorps /home/peacecorps/webserver-init.sh\n",
          "sed -i 's/{{ReleaseTag}}/", { "Ref" : "ReleaseTag" }, "/g' /home/peacecorps/deploy_install_release.sh\n",
          "sh /home/peacecorps/deploy_install_release.sh",
          "chown peacecorps:peacecorps /home/peacecorps/deploy_install_release.sh\n",
          "service nginx restart\n",
          "service peacecorps restart\n",
          "restart peacecorps\n",
          ""
        ]]}}
      }
    },

    "PayGovELB" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "SecurityGroups" : [ { "Ref" : "WebSecurityGroup" } ],
        "Policies": [
          {
            "PolicyName": "EnableProxyProtocolPolicy",
            "PolicyType": "ProxyProtocolPolicyType",
            "Attributes": [
              {
                "Name": "ProxyProtocol",
                "Value": true
              }
            ],
            "InstancePorts": ["443"]
          }
        ],
        "Subnets" : [
          { "Ref" : "PublicSubnetA" },
          { "Ref" : "PublicSubnetB" }
        ],
        "Listeners" : [ {
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP"
        },
        {
          "LoadBalancerPort" : "443",
          "InstancePort" : "443",
          "Protocol" : "TCP"
        }
        ],
        "HealthCheck": {
           "HealthyThreshold" : "2",
           "Interval" : "5",
           "Target" : "TCP:443",
           "Timeout" : "4",
           "UnhealthyThreshold" : "3"
        }
      }
    },
    "PayGovDNS" : {
        "Type" : "AWS::Route53::RecordSetGroup",
        "Properties" : {
          "HostedZoneName" : { "Ref" : "HostedZoneName" },
          "Comment" : "Zone alias targeted to PayGovELB LoadBalancer.",
          "RecordSets" : [
            {
              "Name" : { "Fn::Join" : ["", [{ "Ref" : "PayGovDomainName" }, "."]]},
              "Type" : "A",
              "AliasTarget" : {
                  "HostedZoneId" : { "Fn::GetAtt" : ["PayGovELB", "CanonicalHostedZoneNameID"] },
                  "DNSName" : { "Fn::GetAtt" : ["PayGovELB","CanonicalHostedZoneName"] }
              }
            }
          ]
        }
    }

  }
}